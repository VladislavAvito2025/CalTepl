<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конфигуратор теплиц</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: white;
            padding: 16px;
            margin: 0;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
        }
        h2 {
            color: #333;
            text-align: center;
            margin-bottom: 24px;
            font-size: 24px;
        }
        label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-bottom: 8px;
        }
        select, input {
            width: 100%;
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        select:focus, input:focus {
            border-color: #007BFF;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.2);
            background: #fff;
        }
        button {
            width: 100%;
            background: linear-gradient(135deg, #007BFF, #0056b3);
            color: white;
            padding: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }
        button:hover {
            background: linear-gradient(135deg, #0056b3, #003d80);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .price {
            width: 100%;
            font-size: 20px;
            color: #333;
            text-align: center;
            padding: 16px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }
        .additional-products {
            margin-top: 16px;
        }
        .additional-products .product {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .additional-products .product select,
        .additional-products .product input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .additional-products .product .remove-btn {
            padding: 8px;
            background: linear-gradient(135deg, #ff4d4d, #cc0000);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            transition: all 0.3s ease;
        }
        .additional-products .product .remove-btn:hover {
            background: linear-gradient(135deg, #cc0000, #990000);
        }
        .additional-products .add-product-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #007BFF, #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .additional-products .add-product-btn:hover {
            background: linear-gradient(135deg, #0056b3, #003d80);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            position: relative;
        }
        .modal-content .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content .copy-btn {
            width: 100%;
            background: #007BFF;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .modal-content .copy-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContent">
        <h2>Конфигуратор теплиц</h2>
        <form id="greenhouseConfigurator">
            <label for="type">Тип теплицы:</label>
            <select id="type" name="type" onchange="updateWidthOptions()">
                <option value="Арочная">Арочная</option>
                <option value="Прямостенная">Прямостенная</option>
                <option value="Каплевидная">Каплевидная</option>
                <option value="Домиком">Домиком</option>
            </select>

            <label for="width">Ширина:</label>
            <select id="width" name="width" onchange="updateFrameOptions()">
                <!-- Опции будут обновляться динамически -->
            </select>

            <label for="length">Длина:</label>
            <select id="length" name="length">
                <option value="4 м">4 м</option>
                <option value="6 м">6 м</option>
                <option value="8 м">8 м</option>
                <option value="10 м">10 м</option>
                <option value="12 м">12 м</option>
            </select>

            <label for="frame">Каркас:</label>
            <select id="frame" name="frame">
                <!-- Опции будут обновляться динамически -->
            </select>

            <label for="polycarbonate">Тип поликарбоната:</label>
            <select id="polycarbonate" name="polycarbonate">
                <option value="Поликарбонат Стандарт 4мм">Поликарбонат Стандарт 4мм</option>
                <option value="Поликарбонат Люкс 4мм">Поликарбонат Люкс 4мм</option>
                <option value="Поликарбонат Премиум 6мм">Поликарбонат Премиум 6мм</option>
                <option value="Без поликарбоната">Без поликарбоната</option>
            </select>

            <label for="arcStep">Шаг дуги:</label>
            <select id="arcStep" name="arcStep">
                <option value="1">1 м</option>
                <option value="0.65">0.65 м (+25%)</option>
            </select>

            <label for="foundation">Фундамент:</label>
            <select id="foundation" name="foundation">
                <option value="Брус">Брус</option>
                <option value="Сваи">Сваи</option>
                <option value="Без фундамента" selected>Без фундамента</option>
            </select>

            <label for="assembly">Сборка:</label>
            <select id="assembly" name="assembly">
                <option value="Наша сборка">Наша сборка</option>
                <option value="Без сборки" selected>Без сборки</option>
            </select>

            <label for="delivery">Доставка (км):</label>
            <input type="number" id="delivery" name="delivery" min="0">

            <div class="additional-products">
                <div class="form-group param">
                    <label>Дополнительные товары:</label>
                    <div id="products-list">
                        <!-- Сюда будут добавляться товары -->
                    </div>
                    <button class="add-product-btn" type="button" onclick="addProduct()">+ Добавить товар</button>
                </div>
            </div>

            <button type="button" onclick="calculatePrice()">Рассчитать стоимость</button>
        </form>
        <div class="price" id="totalPrice" onclick="showModal()">Итоговая стоимость: 0 руб</div>
    </div>

    <!-- Модальное окно -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">×</button>
            <div id="modalText">
                <!-- Текст модального окна будет сгенерирован здесь -->
            </div>
            <button class="copy-btn" onclick="copyText()">Скопировать текст</button>
        </div>
    </div>

    <script>
        // Telegram Web App API
        const tg = window.Telegram?.WebApp;

        // Расширяем приложение на весь экран (если доступно)
        if (tg) {
            tg.expand();
        }

        // JSON-данные встроены прямо в код
        const greenhousesData = [
            {
                "Тип теплицы": "Арочная",
                "Ширина": "2.5 м",
                "Длина": "4 м",
                "Каркас": "20х20",
                "Тип поликарбоната": "Без поликарбоната",
                "Цена": "11990 руб."
            },
        ];

        // Данные о ширине в зависимости от типа теплицы
        const widthOptions = {
            "Арочная": ["2.5 м", "3 м", "3.5 м", "4 м"],
            "Прямостенная": ["2.5 м", "3 м", "3.5 м", "4 м"],
            "Каплевидная": ["2.5 м", "3 м", "3.5 м"],
            "Домиком": ["2.5 м", "3 м", "3.5 м", "4 м"]
        };

        // Данные о каркасе в зависимости от типа теплицы
        const frameOptions = {
            "Арочная": ["20х20", "40х20", "20х20 + 20х20", "40х20 + 20х20"],
            "Прямостенная": ["40х20", "40х20 + 20х20"],
            "Каплевидная": ["40х20"],
            "Домиком": ["40х20", "40х20 + 20х20"]
        };

        // Данные о количестве стяжек
        const tiesData = {
            "Арочная": { "2.5 м": 5, "3 м": 5, "3.5 м": 5, "4 м": 9 },
            "Прямостенная": { "2.5 м": 7, "3 м": 7, "3.5 м": 7, "4 м": 9 },
            "Каплевидная": { "2.5 м": 6, "3 м": 6, "3.5 м": 8 },
            "Домиком": { "2.5 м": 6, "3 м": 6, "3.5 м": 6, "4 м": 8 }
        };

        // Данные о снеговой нагрузке
        const snowLoadData = {
            "Арочная": {
                "20х20": 227,
                "40х20": 272,
                "20х20 + 20х20": 314,
                "40х20 + 20х20": 825
            },
            "Каплевидная": { "40х20": 492 },
            "Домиком": {
                "40х20": 483,
                "40х20 + 20х20": 1142
            },
            "Прямостенная": {
                "40х20": 284,
                "40х20 + 20х20": 838
            }
        };

        // Данные о высоте
        const heightData = {
            "Арочная": { "2.5 м": 2.1, "3 м": 2.1, "3.5 м": 2.1, "4 м": 2.8 },
            "Прямостенная": { "2.5 м": 2.1, "3 м": 2.1, "3.5 м": 2.1, "4 м": 2.8 },
            "Каплевидная": { "2.5 м": 2.4, "3 м": 2.4, "3.5 м": 2.8 },
            "Домиком": { "2.5 м": 2.2, "3 м": 2.3, "3.5 м": 2.8, "4 м": 2.8 }
        };

        // Функция для обновления опций ширины
        function updateWidthOptions() {
            const type = document.getElementById('type').value;
            const widthSelect = document.getElementById('width');
            widthSelect.innerHTML = '';
            widthOptions[type].forEach(width => {
                const option = document.createElement('option');
                option.value = width;
                option.textContent = width;
                widthSelect.appendChild(option);
            });
            updateFrameOptions(); // Обновляем каркас после обновления ширины
        }

        // Функция для обновления опций каркаса
        function updateFrameOptions() {
            const type = document.getElementById('type').value;
            const frameSelect = document.getElementById('frame');
            frameSelect.innerHTML = '';
            frameOptions[type].forEach(frame => {
                const option = document.createElement('option');
                option.value = frame;
                option.textContent = frame;
                frameSelect.appendChild(option);
            });
        }

        // Функция для добавления нового товара
        function addProduct() {
            const productsList = document.getElementById("products-list");
            const productDiv = document.createElement("div");
            productDiv.className = "product";

            const productSelect = document.createElement("select");
            productSelect.innerHTML = `
                <option value="1690">Капельный полив механический</option>
                <option value="4490">Капельный полив автоматический</option>
                <option value="2590">Автомат для форточки</option>
                <option value="1590">Паропропускающая лента</option>
                <option value="1990">Оцинкованная лента</option>
                <option value="1490">Дополнительная форточка</option>
            `;

            const quantityInput = document.createElement("input");
            quantityInput.type = "number";
            quantityInput.min = "0";
            quantityInput.placeholder = "Количество";

            const removeButton = document.createElement("button");
            removeButton.className = "remove-btn";
            removeButton.innerHTML = '×';
            removeButton.onclick = () => productDiv.remove();

            productDiv.appendChild(productSelect);
            productDiv.appendChild(quantityInput);
            productDiv.appendChild(removeButton);
            productsList.appendChild(productDiv);
        }

        // Функция для расчёта итоговой стоимости
        function calculatePrice() {
            const type = document.getElementById('type').value;
            const width = document.getElementById('width').value;
            const length = document.getElementById('length').value;
            const frame = document.getElementById('frame').value;
            const polycarbonate = document.getElementById('polycarbonate').value;
            const arcStep = parseFloat(document.getElementById('arcStep').value);
            const foundation = document.getElementById('foundation').value;
            const assembly = document.getElementById('assembly').value;
            const delivery = parseInt(document.getElementById('delivery').value) || 0;

            // Поиск совпадений в JSON
            const match = greenhousesData.find(item =>
                item["Тип теплицы"] === type &&
                item["Ширина"] === width &&
                item["Длина"] === length &&
                item["Каркас"] === frame &&
                item["Тип поликарбоната"] === polycarbonate
            );

            if (match) {
                // Извлечение цены из JSON и удаление "руб."
                let basePrice = parseFloat(match["Цена"].replace(" руб.", ""));

                // Учёт шага дуги
                if (arcStep === 0.65) {
                    basePrice *= 1.25;
                }

                // Учёт фундамента
                const foundationPrices = {
                    "Брус": { "4 м": 4790, "6 м": 6290, "8 м": 7790, "10 м": 9290, "12 м": 10790 },
                    "Сваи": { "4 м": 2988, "6 м": 3984, "8 м": 4980, "10 м": 5976, "12 м": 6972 },
                    "Без фундамента": { "4 м": 0, "6 м": 0, "8 м": 0, "10 м": 0, "12 м": 0 }
                };
                const foundationPrice = foundationPrices[foundation][length] || 0;

                // Учёт сборки
                let assemblyPrice = 0;
                if (assembly === "Наша сборка") {
                    assemblyPrice = assemblyPrices[type][width][length] || 0;
                }

                // Учёт доставки
                const deliveryPrice = Math.max(1000, delivery * 40);

                // Учёт дополнительных товаров
                let additionalProductsCost = 0;
                const products = document.querySelectorAll("#products-list .product");
                products.forEach(product => {
                    const quantity = parseFloat(product.querySelector("input").value) || 0;
                    const price = parseFloat(product.querySelector("select").value) || 0;
                    additionalProductsCost += quantity * price;
                });

                // Общая стоимость
                const totalPrice = basePrice + foundationPrice + assemblyPrice + deliveryPrice + additionalProductsCost;
                document.getElementById('totalPrice').innerText = `Итоговая стоимость: ${totalPrice.toFixed(2)} руб`;
            } else {
                document.getElementById('totalPrice').innerText = "Теплица с такими параметрами не найдена.";
            }
        }

        // Функция для отображения модального окна
        function showModal() {
            const type = document.getElementById('type').value;
            const width = document.getElementById('width').value;
            const length = document.getElementById('length').value;
            const frame = document.getElementById('frame').value;
            const polycarbonate = document.getElementById('polycarbonate').value;
            const arcStep = document.getElementById('arcStep').value;
            const foundation = document.getElementById('foundation').value;
            const assembly = document.getElementById('assembly').value;
            const totalPrice = document.getElementById('totalPrice').innerText;

            // Получение данных о стяжках, снеговой нагрузке и высоте
            const ties = tiesData[type][width];
            const snowLoad = snowLoadData[type][frame] || 0;
            const height = heightData[type][width];

            // Формирование текста для модального окна
            const modalText = `
                ТЕПЛИЦА ${type}
                ☀️ Поликарбонат с защитой от ультрафиолета UV-400
                ⚙️ Цельногнутые дуги из стальной замкнутой трубы
                ⚙️ Каркас из оцинкованной внутри и снаружи стали (полностью защита от ржавчины и коррозии)
                ⚙️ Краб-система на 4 болтах
                ❄️ Не требует подпорок на зиму
                ✏️ Гарантия 15 лет!!!
                -----------------
                Каркас: ${frame}
                Шаг дуги: ${arcStep} м
                Поликарбонат: ${polycarbonate}
                Размеры (ШхДхВ): ${width}х${length}х${height} м
                Снеговая нагрузка: ${snowLoad} кг/м²
                Горизонтальные стяжки: ${ties} шт
                Комплектация: 2 двери, 2 форточки
                Фундамент: ${foundation}
                Сборка: ${assembly}
                -----------------
                Стоимость теплицы со скидкой до ${getFutureDate(6)}: ${totalPrice} (в ст. включены: товарный чек, каркас на краб-системе, поликарбонат, инструкция по сборке)
            `;

            // Вставка текста в модальное окно
            document.getElementById('modalText').innerText = modalText;

            // Отображение модального окна
            document.getElementById('modal').style.display = 'flex';
        }

        // Функция для закрытия модального окна
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Функция для копирования текста
        function copyText() {
            const text = document.getElementById('modalText').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('Текст скопирован!');
            });
        }

        // Функция для получения даты + n дней
        function getFutureDate(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            return date.toLocaleDateString('ru-RU');
        }

        // Инициализация ширины и каркаса при загрузке страницы
        updateWidthOptions();
    </script>
</body>
</html>
